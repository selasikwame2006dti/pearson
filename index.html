<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Challenge try Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!-- Open Graph Meta Tags for Link Preview -->
    <meta property="og:title" content="Challenge Exam Prep Quiz">
    <meta property="og:description" content="Test your knowledge on Team Development, Conflict Resolution, Growth Mindset, Culture, and Addiction! Prepare for your Challenge exams with this interactive quiz.">
    <meta property="og:image" content="https://placehold.co/1200x630/4f46e5/ffffff?text=Challenge+Quiz">
    <meta property="og:url" content="https://pearson-cyan.vercel.app">
    <meta property="og:type" content="website">
    <!-- End Open Graph Meta Tags -->

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            overflow-x: hidden;
        }
        .quiz-container {
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            padding: 2rem;
            width: 100%;
            max-width: 600px;
            text-align: center;
            transition: all 0.5s ease-in-out;
            opacity: 0;
            transform: translateY(20px);
        }
        .quiz-container.show {
            opacity: 1;
            transform: translateY(0);
        }
        .option-button {
            background-color: #e2e8f0;
            color: #334155;
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            text-align: left;
            width: 100%;
            font-size: 1.1rem;
            border: 1px solid transparent;
        }
        .option-button:hover:not(.disabled) {
            background-color: #cbd5e1;
            transform: translateY(-2px);
        }
        .option-button.correct {
            background-color: #d1fae5;
            color: #065f46;
            border-color: #34d399;
        }
        .option-button.incorrect {
            background-color: #fee2e2;
            color: #991b1b;
            border-color: #ef4444;
        }
        .option-button.disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        #timer-bar {
            transition: width 1s linear; /* Animate width change over 1 second */
        }
        .time-low-pulse {
             background-image: linear-gradient(to right, #ef4444, #b91c1c);
             animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
        .score-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            background-color: #f8fafc;
            border-radius: 1.5rem;
            margin-top: 2rem;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
            opacity: 0;
            transform: scale(0.9);
            transition: all 0.5s ease-in-out;
        }
        .score-card.show {
            opacity: 1;
            transform: scale(1);
        }
        .score-icon {
            width: 80px;
            height: 80px;
            margin-bottom: 1.5rem;
        }
        .start-button {
            background-color: #4f46e5;
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            font-size: 1.25rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .start-button:hover {
            background-color: #4338ca;
            transform: translateY(-2px);
        }
        .start-button:active {
            transform: translateY(0);
            box-shadow: none;
        }
        .social-share-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
        }
        .social-share-buttons button {
            background-color: #6b7280;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background-color 0.3s ease;
        }
        .social-share-buttons button:hover {
            background-color: #4b5563;
        }
        .social-share-buttons .whatsapp { background-color: #25D366; }
        .social-share-buttons .whatsapp:hover { background-color: #1DA851; }
        .social-share-buttons .facebook { background-color: #1877F2; }
        .social-share-buttons .facebook:hover { background-color: #145CB3; }
        .social-share-buttons .pinterest { background-color: #E60023; }
        .social-share-buttons .pinterest:hover { background-color: #B3001C; }
        .social-share-buttons .teams { background-color: #6264A7; }
        .social-share-buttons .teams:hover { background-color: #4A4C84; }

        .challenge-info {
            background-color: #e0f2fe;
            border: 1px solid #90cdf4;
            color: #2c5282;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
            font-weight: 600;
        }
        .input-field {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1.5rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.75rem;
            font-size: 1.1rem;
            text-align: center;
        }
        @media (max-width: 640px) {
            .quiz-container { padding: 1.5rem; }
            .option-button { font-size: 1rem; padding: 0.6rem 1rem; }
            .score-icon { width: 60px; height: 60px; }
            .start-button { padding: 0.8rem 1.5rem; font-size: 1.1rem; }
            .social-share-buttons { flex-wrap: wrap; }
            .social-share-buttons button { width: calc(50% - 0.5rem); justify-content: center; }
        }

        /* Color classes for score */
        .text-red-600 { color: #dc2626; }
        .text-orange-600 { color: #ea580c; }
        .text-yellow-600 { color: #eab308; }
        .text-lime-600 { color: #65a30d; }
        .text-green-600 { color: #16a34a; }

        /* Modal for Wrong Answers */
        #wrong-answers-modal {
            background-color: rgba(0, 0, 0, 0.75);
        }
        #wrong-answers-modal > div {
            max-height: 90vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div id="quiz-app" class="quiz-container show">
        <div id="start-screen" class="text-center">
            <h1 class="text-4xl font-bold text-gray-800 mb-6">The Challenge Try Quiz</h1>
            <p class="text-lg text-gray-600 mb-4">Ready to test your knowledge on various "Challenge" topics against the clock? Let's begin!</p>
            <input type="text" id="user-name-input" class="input-field" placeholder="Enter your name to start" maxlength="30">
            <button id="start-button" class="start-button">Start Quiz</button>
        </div>

        <div id="challenge-intro-screen" class="hidden text-center">
            <h1 class="text-4xl font-bold text-gray-800 mb-6">Challenge Accepted!</h1>
            <div class="challenge-info">
                <p class="mb-2">You are challenging <span id="challenger-name-display" class="font-bold"></span>'s score of <span id="challenger-score-display" class="font-bold"></span> out of 25.</p>
                <p id="challenger-speed-display" class="mb-4"></p>
                <p class="mb-4">Enter your name to take on the challenge!</p>
                <input type="text" id="challenger-name-input" class="input-field" placeholder="Your name" maxlength="30">
            </div>
            <button id="start-challenge-button" class="start-button">Start Challenge</button>
        </div>

        <div id="quiz-screen" class="hidden">
            <div id="quiz-header" class="mb-6">
                 <div class="flex justify-between items-center text-gray-600 mb-2">
                    <p id="question-count" class="text-sm font-semibold">Question 1 of 25</p>
                    <p id="timer-text" class="text-sm font-semibold">Time: 20s</p>
                </div>
                <div id="timer-container" class="w-full bg-gray-200 rounded-full h-2.5">
                     <div id="timer-bar" class="bg-gradient-to-r from-indigo-500 to-blue-500 h-2.5 rounded-full" style="width: 100%;"></div>
                </div>
            </div>
            <h2 id="question-text" class="text-2xl font-semibold text-gray-900 mb-8 leading-relaxed"></h2>
            <div id="options-container" class="grid grid-cols-1 gap-4"></div>
        </div>

        <div id="score-card" class="score-card hidden">
            <div id="score-icon-display" class="score-icon"></div>
            <h3 id="score-text" class="text-3xl font-bold text-gray-800 mb-4"></h3>
            <!-- New dashboard elements -->
            <p id="average-speed-display" class="text-lg text-gray-600 mb-2"></p>
            <p id="proficiency-score-display" class="text-lg font-bold mb-4"></p>
            <!-- End new dashboard elements -->
            <p id="score-review" class="text-lg text-gray-600 mb-8"></p>
            <div id="challenge-outcome-message" class="text-xl font-semibold text-blue-700 mb-4 hidden"></div>
            <div class="flex flex-col items-center gap-4">
                <button id="review-answers-button" class="start-button bg-purple-600 hover:bg-purple-700">Review Wrong Answers</button>
                <button id="restart-button" class="start-button">Play Again</button>
                <div id="share-section" class="w-full">
                    <p class="text-gray-700 font-semibold mb-2">Share your score and challenge others!</p>
                    <div class="social-share-buttons">
                        <button id="share-whatsapp" class="whatsapp"><i class="fab fa-whatsapp"></i> WhatsApp</button>
                        <button id="share-facebook" class="facebook"><i class="fab fa-facebook-f"></i> Facebook</button>
                        <button id="share-pinterest" class="pinterest"><i class="fab fa-pinterest-p"></i> Pinterest</button>
                        <button id="share-teams" class="teams"><i class="fab fa-microsoftteams"></i> Teams</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Wrong Answers Review -->
    <div id="wrong-answers-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Review Your Answers</h3>
            <div id="wrong-answers-list">
                <!-- Wrong answers will be injected here -->
            </div>
            <button class="mt-6 bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600" onclick="document.getElementById('wrong-answers-modal').classList.add('hidden')">Close</button>
        </div>
    </div>

    <script>
        // --- Fallback for crypto.randomUUID() ---
        function generateUUID() {
            if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                return crypto.randomUUID();
            }
            // Fallback for environments where crypto.randomUUID is not available
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // --- Quiz Questions Data (25 Questions) ---
        // Questions are designed for individuals between 16 and 25 years of age,
        // covering topics from the provided learning materials for the "Challenge" subject.
        const allQuestions = [
            // People and Team Development (10 Questions)
            { question: "What is the primary definition of a work team?", options: ["A group of people in the same building", "People working together to reach a common goal", "Individuals reporting to the same manager", "A collection of employees with similar job titles"], correctAnswer: 1, topic: "Introduction to Work Teams" },
            { question: "Which of the following is essential for a group to be considered a team?", options: ["Having identical skills", "Working in isolation", "A shared objective", "Being in the same physical location"], correctAnswer: 2, topic: "Introduction to Work Teams" },
            { question: "A team composed of all finance officers in a company is an example of a...", options: ["Project Team", "Functional Team", "Task Force", "Self-managed Team"], correctAnswer: 1, topic: "Types of Work Teams" },
            { question: "Which team is formed for a specific task and disbands upon completion?", options: ["Functional Team", "Project Team", "Troubleshooting Team", "Inter-working Team"], correctAnswer: 1, topic: "Types of Work Teams" },
            { question: "A production line team that handles its own quality control without a formal boss is a...", options: ["Functional Team", "Project Team", "Self-managed Team", "Task Force"], correctAnswer: 2, topic: "Types of Work Teams" },
            { question: "In Tuckman's Model, which stage is characterized by conflict and competition?", options: ["Forming", "Storming", "Norming", "Adjourning"], correctAnswer: 1, topic: "Stages of Team Development" },
            { question: "When a team starts to agree on standards and establish norms, it is in the...", options: ["Forming", "Storming", "Norming", "Performing"], correctAnswer: 2, topic: "Stages of Team Development" },
            { question: "The final stage of Tuckman's Model, where the team celebrates and disbands, is called...", options: ["Performing", "Forming", "Concluding", "Adjourning"], correctAnswer: 3, topic: "Stages of Team Development" },
            { question: "Empowerment in a team context means...", options: ["Telling employees exactly what to do", "Trusting employees to make smart decisions on their own", "Removing all rules", "Giving employees more work"], correctAnswer: 1, topic: "Leadership, Empowerment, Communication" },
            { question: "Good communication in a team primarily involves...", options: ["Cutting each other off to be more efficient", "Listening to understand, not just to reply", "Using complex jargon", "Communicating only through email"], correctAnswer: 1, topic: "Leadership, Empowerment, Communication" },
            // Conflict Resolution & Anger Management (5 Questions)
            { question: "Conflict is generally defined as...", options: ["Always violent disagreements", "Disagreements in ideas, beliefs, or interests", "A lack of communication", "A sign of a failing team"], correctAnswer: 1, topic: "Conflict Resolution" },
            { question: "Which type of conflict arises from differences in personal traits or styles?", options: ["Task Conflict", "Leadership Conflict", "Personality Conflict", "Value Conflict"], correctAnswer: 2, topic: "Conflict Resolution" },
            { question: "The 'Avoiding' conflict resolution style is characterized by...", options: ["Trying to satisfy one's own concerns without regard for others", "Finding a win-win solution", "Avoiding dealing with the conflict issue", "Finding an acceptable agreement that partially satisfies both sides"], correctAnswer: 2, topic: "Conflict Resolution" },
            { question: "Anger is a basic human emotional response typically triggered by...", options: ["Happiness or joy", "A threat, injustice, hurt, or frustration", "Complete calm", "Lack of work"], correctAnswer: 1, topic: "Anger Management" },
            { question: "What is the primary goal of anger management?", options: ["To eliminate all feelings of anger", "To suppress anger until it disappears", "To reduce emotional feelings and physiological arousal caused by anger", "To blame others for your anger"], correctAnswer: 2, topic: "Anger Management" },
            // Growth Mindset (3 Questions)
            { question: "A 'Fixed Mindset' is characterized by the belief that abilities...", options: ["Can change significantly with effort", "Are inherent and cannot change", "Are only developed through formal education", "Are irrelevant to success"], correctAnswer: 1, topic: "Growth Mindset" },
            { question: "People with a 'Growth Mindset' tend to...", options: ["Avoid challenges and stick to familiar tasks", "Believe their intelligence is set in stone", "Be open and ready to take on challenges, looking for ways to achieve goals", "Give up easily when faced with difficulties"], correctAnswer: 2, topic: "Growth Mindset" },
            { question: "Which of the following is a benefit of having a 'Changed Mindset'?", options: ["Resistance to new ideas", "Stagnation and lack of progress", "Personal growth and flexibility", "Increased anxiety about change"], correctAnswer: 2, topic: "Growth Mindset" },
            // Culture and Development (3 Questions)
            { question: "According to the learning materials, 'Nature' refers to...", options: ["Anything created by human beings", "Material products of society", "Anything on earth and in the universe not created or influenced by human beings", "Social interactions and traditions"], correctAnswer: 2, topic: "Culture and Development" },
            { question: "Culture is described as polysemous, meaning it...", options: ["Has only one strict definition", "Is only about material products", "Has more than one meaning and means different things to different people", "Is fixed and never changes"], correctAnswer: 2, topic: "Culture and Development" },
            { question: "When habits are accepted by society, they become...", options: ["Traditions", "Rules", "Norms", "Heritage resources"], correctAnswer: 2, topic: "Culture and Development" },
            // Addiction (4 Questions)
            { question: "Addiction is defined as a compulsive need for and use of a habit-forming substance or activity, characterized by...", options: ["Occasional use for pleasure", "Ability to stop easily despite consequences", "Inability to stop despite harmful consequences", "Only physical dependence"], correctAnswer: 2, topic: "Addiction" },
            { question: "Which of these is a behavioral addiction?", options: ["Alcohol", "Nicotine", "Gambling", "Prescription drugs"], correctAnswer: 2, topic: "Addiction" },
            { question: "Addictive substances primarily impact the brain by triggering a surge in which neurotransmitter?", options: ["Serotonin", "Endorphin", "Dopamine", "Adrenaline"], correctAnswer: 2, topic: "Addiction" },
            { question: "One of the social consequences of addiction mentioned is...", options: ["Improved physical health", "Increased financial stability", "Social isolation and damaged relationships", "Enhanced career opportunities"], correctAnswer: 2, topic: "Addiction" }
        ];

        let questionsToAsk = [];
        let currentQuestionIndex = 0;
        let score = 0;
        const totalQuestionsPerSession = 25;
        let userName = "Guest";
        let challengedSharerName = null;
        let challengedSharerScore = null;
        let challengedSharerAvgSpeed = null; // Store challenged average speed
        let challengedSharerProficiency = null; // Store challenged proficiency
        let timerInterval;
        let timeLeft = 25; // Changed to 20 seconds
        let questionStartTime; // To track time for each question
        let totalTimeTaken = 0; // To sum up time for average speed
        let wrongAnswersLog = []; // To store wrong answers for review

        // --- DOM Elements ---
        const startScreen = document.getElementById('start-screen');
        const userNameInput = document.getElementById('user-name-input');
        const challengeIntroScreen = document.getElementById('challenge-intro-screen');
        const challengerNameDisplay = document.getElementById('challenger-name-display');
        const challengerScoreDisplay = document.getElementById('challenger-score-display');
        const challengerSpeedDisplay = document.getElementById('challenger-speed-display'); // New element
        const challengerNameInput = document.getElementById('challenger-name-input');
        const startChallengeButton = document.getElementById('start-challenge-button');
        const quizScreen = document.getElementById('quiz-screen');
        const scoreCard = document.getElementById('score-card');
        const startButton = document.getElementById('start-button');
        const restartButton = document.getElementById('restart-button');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const questionCountDisplay = document.getElementById('question-count');
        const timerText = document.getElementById('timer-text');
        const timerBar = document.getElementById('timer-bar');
        const scoreTextEl = document.getElementById('score-text');
        const scoreReview = document.getElementById('score-review');
        const scoreIconDisplay = document.getElementById('score-icon-display');
        const quizAppContainer = document.getElementById('quiz-app');
        const shareWhatsappButton = document.getElementById('share-whatsapp');
        const shareFacebookButton = document.getElementById('share-facebook');
        const sharePinterestButton = document.getElementById('share-pinterest');
        const shareTeamsButton = document.getElementById('share-teams');
        const shareSection = document.getElementById('share-section');
        const challengeOutcomeMessage = document.getElementById('challenge-outcome-message');
        const averageSpeedDisplay = document.getElementById('average-speed-display'); // New element
        const proficiencyScoreDisplay = document.getElementById('proficiency-score-display'); // New element
        const reviewAnswersButton = document.getElementById('review-answers-button'); // New button
        const wrongAnswersModal = document.getElementById('wrong-answers-modal'); // Modal element
        const wrongAnswersList = document.getElementById('wrong-answers-list'); // List inside modal


        // --- SVG Icons for score card ---
        const scoreIcons = {
            trophy: `<svg class="score-icon text-amber-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 001.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z"></path><path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z"></path></svg>`,
            medal: `<svg class="score-icon text-blue-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>`,
            star: `<svg class="score-icon text-yellow-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>`,
            brain: `<svg class="score-icon text-pink-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 3.5a5.5 5.5 0 00-5.5 5.5c0 1.258.468 2.41 1.25 3.317V17.5a.5.5 0 00.5.5h7.5a.5.5 0 00.5-.5v-5.183c.782-.907 1.25-2.06 1.25-3.317A5.5 5.5 0 0010 3.5zM8.5 12.5a.5.5 0 01-.5-.5V11a.5.5 0 011 0v1a.5.5 0 01-.5.5zm3 0a.5.5 0 01-.5-.5V11a.5.5 0 011 0v1a.5.5 0 01-.5.5z"></path><path d="M10 2a1 1 0 00-1 1v.5a.5.5 0 001 0V3a1 1 0 00-1-1z"></path></svg>`,
            book: `<svg class="score-icon text-green-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 11-2 0V4a1 1 0 00-1-1H7a1 1 0 00-1 1v12a1 1 0 11-2 0V4z" clip-rule="evenodd"></path></svg>`
        };

        // --- Utility Functions ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function showModalMessage(message) {
            const modal = document.createElement('div');
            modal.classList.add('fixed', 'inset-0', 'bg-gray-800', 'bg-opacity-75', 'flex', 'items-center', 'justify-center', 'z-50', 'p-4');
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl text-center max-w-sm mx-auto">
                    <p class="text-lg font-semibold mb-4">${message}</p>
                    <button class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600" onclick="this.parentNode.parentNode.remove()">OK</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Function to get color based on percentage for dashboard
        function getScoreColor(percentage) {
            if (percentage >= 90) return 'text-green-600'; // Deep Green
            if (percentage >= 75) return 'text-lime-600'; // Lighter Green
            if (percentage >= 50) return 'text-yellow-600'; // Yellow
            if (percentage >= 25) return 'text-orange-600'; // Orange
            return 'text-red-600'; // Red for bad
        }

        // --- Quiz Flow Functions ---
        function startGame(isChallenge = false) {
            let nameInputSource = isChallenge ? challengerNameInput : userNameInput;
            userName = nameInputSource.value.trim();

            if (!userName) {
                showModalMessage("Please enter your name to start the quiz!");
                return;
            }
            if (userName.length > 30) {
                showModalMessage("Name cannot exceed 30 characters.");
                return;
            }

            currentQuestionIndex = 0;
            score = 0;
            totalTimeTaken = 0; // Reset total time
            wrongAnswersLog = []; // Reset wrong answers log

            shuffleArray(allQuestions);
            questionsToAsk = allQuestions.slice(0, totalQuestionsPerSession);

            startScreen.classList.add('hidden');
            challengeIntroScreen.classList.add('hidden');
            scoreCard.classList.add('hidden');
            quizScreen.classList.remove('hidden');
            quizAppContainer.classList.add('show');

            displayQuestion();
        }

        function startTimer() {
            clearInterval(timerInterval); // Clear any existing timer
            timeLeft = 20; // Reset timer to 20 seconds
            questionStartTime = Date.now(); // Record start time for this question
            
            // Initial UI update
            timerText.textContent = `Time: ${timeLeft}s`;
            timerBar.style.width = '100%';
            timerBar.classList.remove('time-low-pulse', 'bg-red-500');
            timerBar.classList.add('bg-gradient-to-r', 'from-indigo-500', 'to-blue-500');


            timerInterval = setInterval(() => {
                timeLeft--;
                timerText.textContent = `Time: ${timeLeft}s`;
                const percentageLeft = (timeLeft / 20) * 100; // Calculate percentage based on 20s
                timerBar.style.width = `${percentageLeft}%`;

                if (timeLeft <= 5 && !timerBar.classList.contains('time-low-pulse')) {
                    timerBar.classList.remove('bg-gradient-to-r', 'from-indigo-500', 'to-blue-500');
                    timerBar.classList.add('time-low-pulse', 'bg-red-500');
                }

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    handleTimeout();
                }
            }, 1000);
        }
        
        function handleTimeout() {
            const timeTaken = (Date.now() - questionStartTime) / 1000;
            totalTimeTaken += timeTaken;

            // Log the wrong answer due to timeout
            const questionData = questionsToAsk[currentQuestionIndex];
            wrongAnswersLog.push({
                question: questionData.question,
                userAnswer: "Timed Out / No Answer",
                correctAnswer: questionData.options[questionData.correctAnswer]
            });

            disableOptions(null); // Pass null as there's no selected button
            moveToNextQuestion();
        }

        function disableOptions(selectedButton) {
            const buttons = optionsContainer.querySelectorAll('.option-button');
            const correctAnswerText = questionsToAsk[currentQuestionIndex].options[questionsToAsk[currentQuestionIndex].correctAnswer];

            buttons.forEach(button => {
                button.classList.add('disabled', 'opacity-70');
                button.onclick = null;
                
                // Show correct answer if the choice was wrong or timed out
                if (button.textContent === correctAnswerText) {
                    button.classList.add('correct');
                } else if (button === selectedButton) {
                    button.classList.add('incorrect');
                }
            });
        }

        function moveToNextQuestion() {
            questionText.style.opacity = '0';
            optionsContainer.style.opacity = '0';
            setTimeout(() => {
                currentQuestionIndex++;
                displayQuestion();
            }, 1500); // Wait 1.5 seconds before showing the next question
        }

        function displayQuestion() {
            if (currentQuestionIndex < totalQuestionsPerSession) {
                startTimer();
                const question = questionsToAsk[currentQuestionIndex];
                
                const shuffledOptions = [...question.options];
                shuffleArray(shuffledOptions);

                questionText.textContent = question.question;
                optionsContainer.innerHTML = '';

                shuffledOptions.forEach(optionText => {
                    const button = document.createElement('button');
                    button.classList.add('option-button');
                    button.textContent = optionText;
                    button.onclick = () => selectAnswer(button);
                    optionsContainer.appendChild(button);
                });

                questionCountDisplay.textContent = `Question ${currentQuestionIndex + 1} of ${totalQuestionsPerSession}`;

                questionText.style.opacity = '0';
                optionsContainer.style.opacity = '0';
                setTimeout(() => {
                    questionText.style.transition = 'opacity 0.5s ease-in-out';
                    optionsContainer.style.transition = 'opacity 0.5s ease-in-out';
                    questionText.style.opacity = '1';
                    optionsContainer.style.opacity = '1';
                }, 50);
            } else {
                showScoreCard();
            }
        }
        
        function selectAnswer(selectedButton) {
            clearInterval(timerInterval); // Stop the timer
            
            const timeTaken = (Date.now() - questionStartTime) / 1000; // Time taken for this question
            totalTimeTaken += timeTaken; // Add to total

            const correctAnswerText = questionsToAsk[currentQuestionIndex].options[questionsToAsk[currentQuestionIndex].correctAnswer];
            const isCorrect = selectedButton.textContent === correctAnswerText;

            if (isCorrect) {
                score++;
            } else {
                // Log the wrong answer
                const questionData = questionsToAsk[currentQuestionIndex];
                wrongAnswersLog.push({
                    question: questionData.question,
                    userAnswer: selectedButton.textContent,
                    correctAnswer: questionData.options[questionData.correctAnswer]
                });
            }
            // The disableOptions function will handle marking correct/incorrect
            disableOptions(selectedButton);
            
            moveToNextQuestion();
        }

        function showScoreCard() {
            quizScreen.classList.add('hidden');
            scoreCard.classList.remove('hidden');
            scoreCard.classList.add('show');
            shareSection.classList.remove('hidden');

            const scorePercentage = (score / totalQuestionsPerSession) * 100;
            const averageSpeed = totalQuestionsPerSession > 0 ? (totalTimeTaken / totalQuestionsPerSession).toFixed(2) : 0;
            const proficiencyScore = scorePercentage; // Using score percentage as proficiency

            scoreTextEl.textContent = `${userName}, you scored ${score} out of ${totalQuestionsPerSession}!`;
            averageSpeedDisplay.textContent = `Average Speed: ${averageSpeed} seconds per question`;
            proficiencyScoreDisplay.textContent = `Knowledge Proficiency: ${proficiencyScore.toFixed(0)}%`;
            proficiencyScoreDisplay.className = `text-lg font-bold mb-4 ${getScoreColor(proficiencyScore)}`;


            let reviewMessage = '';
            let iconSvg = '';

            if (scorePercentage === 100) {
                reviewMessage = "Flawless Victory! You've mastered the material. You're ready for any challenge!";
                iconSvg = scoreIcons.trophy;
            } else if (scorePercentage >= 90) {
                reviewMessage = "Outstanding! You have an expert-level grasp of these topics. Well done!";
                iconSvg = scoreIcons.medal;
            } else if (scorePercentage >= 75) {
                reviewMessage = "Excellent work! Your knowledge is impressive. Keep up the great momentum!";
                iconSvg = scoreIcons.star;
            } else if (scorePercentage >= 50) {
                reviewMessage = "Good job! You're on the right track. A little more practice and you'll be an expert.";
                iconSvg = scoreIcons.brain;
            } else {
                reviewMessage = "Nice try! This was great practice. Keep reviewing the topics to be fully prepared for the real test on paper.";
                iconSvg = scoreIcons.book;
            }

            scoreReview.textContent = reviewMessage;
            scoreIconDisplay.innerHTML = iconSvg;

            if (challengedSharerName && challengedSharerScore !== null) { // Check if in challenge mode
                handleChallengeOutcome(averageSpeed);
            }
            // No need to call saveScoreForSharing here, as sharing is now done via URL parameters
        }
        
        function handleChallengeOutcome(myAvgSpeed) {
            shareSection.classList.add('hidden');
            challengeOutcomeMessage.classList.remove('hidden');
            let outcomeText = "";
            
            if (score > challengedSharerScore) {
                outcomeText = `🎉 Congratulations! You beat ${challengedSharerName}'s score of ${challengedSharerScore}!`;
            } else if (score === challengedSharerScore) {
                if (myAvgSpeed < challengedSharerAvgSpeed) {
                    outcomeText = `🚀 Amazing! You matched ${challengedSharerName}'s score of ${challengedSharerScore} AND were faster!`;
                } else if (myAvgSpeed === challengedSharerAvgSpeed) {
                    outcomeText = `🤝 You matched ${challengedSharerName}'s score of ${challengedSharerScore} and speed! A true competitor!`;
                } else {
                    outcomeText = `🤝 You matched ${challengedSharerName}'s score of ${challengedSharerScore}!`;
                }
            } else {
                outcomeText = `Keep going! You didn't beat ${challengedSharerName}'s score of ${challengedSharerScore} this time.`;
            }
            challengeOutcomeMessage.textContent = outcomeText;
            // Reset challenge specific variables (these are read from URL, so just clear local state)
            challengedSharerName = null;
            challengedSharerScore = null;
            challengedSharerAvgSpeed = null;
            challengedSharerProficiency = null;
            challengerSpeedDisplay.textContent = ""; // Clear challenger speed display
        }

        function resetQuiz() {
            scoreCard.classList.remove('show');
            // Ensure quizAppContainer fades out before resetting
            quizAppContainer.classList.remove('show'); 
            
            setTimeout(() => {
                // Reset all states and hidden classes
                userNameInput.value = "";
                challengerNameInput.value = "";
                startScreen.classList.remove('hidden');
                challengeIntroScreen.classList.add('hidden');
                quizScreen.classList.add('hidden');
                scoreCard.classList.add('hidden');
                challengeOutcomeMessage.classList.add('hidden');
                averageSpeedDisplay.textContent = ""; 
                proficiencyScoreDisplay.textContent = ""; 
                proficiencyScoreDisplay.classList.remove('text-red-600', 'text-orange-600', 'text-yellow-600', 'text-lime-600', 'text-green-600'); // Remove all color classes
                proficiencyScoreDisplay.classList.add('text-lg', 'font-bold', 'mb-4'); // Re-add default classes
                
                // After resetting, make the quizAppContainer fade back in for the start screen
                quizAppContainer.classList.add('show'); 
            }, 500); // This delay matches the CSS transition duration for fade-out
        }

        // --- Share Functions (Now using URL parameters directly) ---
        function getShareUrl() {
            const currentAvgSpeed = totalQuestionsPerSession > 0 ? (totalTimeTaken / totalQuestionsPerSession).toFixed(2) : 0;
            const currentProficiency = (score / totalQuestionsPerSession) * 100;

            const params = new URLSearchParams();
            params.set('challengeName', encodeURIComponent(userName));
            params.set('challengeScore', score);
            params.set('challengeTotal', totalQuestionsPerSession);
            params.set('challengeSpeed', currentAvgSpeed);
            params.set('challengeProficiency', currentProficiency.toFixed(0));
            // Stringify wrongAnswersLog to pass it in the URL (be mindful of URL length limits for very long logs)
            params.set('wrongAnswersLog', encodeURIComponent(JSON.stringify(wrongAnswersLog)));

            return `${window.location.origin}${window.location.pathname}?${params.toString()}`;
        }

        function getShareText() {
            return encodeURIComponent(`${userName} scored ${score} out of ${totalQuestionsPerSession} on the Ultimate Challenge Quiz! Can you beat my score?`);
        }
        
        function setupShareListeners() {
            const shareButtons = [
                { el: shareWhatsappButton, getUrl: () => `https://wa.me/?text=${getShareText()}%0A${encodeURIComponent(getShareUrl())}` },
                { el: shareFacebookButton, getUrl: () => `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(getShareUrl())}&quote=${getShareText()}` },
                { el: sharePinterestButton, getUrl: () => `https://pinterest.com/pin/create/button/?url=${encodeURIComponent(getShareUrl())}&description=${getShareText()}` },
                { el: shareTeamsButton, getUrl: () => `https://teams.microsoft.com/share?msgText=${getShareText()}&mask=false&href=${encodeURIComponent(getShareUrl())}` }
            ];
            shareButtons.forEach(btn => {
                btn.el.onclick = () => {
                    // No need for currentShareId check, as data is generated on the fly
                    window.open(btn.getUrl(), '_blank');
                };
            });
        }

        // --- Challenge Logic (Fetching data from URL parameters directly) ---
        function checkChallengeInUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            
            const name = urlParams.get('challengeName');
            const scoreParam = urlParams.get('challengeScore');
            const totalParam = urlParams.get('challengeTotal');
            const speedParam = urlParams.get('challengeSpeed');
            const proficiencyParam = urlParams.get('challengeProficiency');
            const wrongAnswersLogParam = urlParams.get('wrongAnswersLog');

            if (name && scoreParam !== null && totalParam !== null && speedParam !== null && proficiencyParam !== null) {
                challengedSharerName = decodeURIComponent(name);
                challengedSharerScore = parseInt(scoreParam);
                // challengedTotalQuestions = parseInt(totalParam); // Not strictly needed for display, but good to have
                challengedSharerAvgSpeed = parseFloat(speedParam);
                challengedSharerProficiency = parseFloat(proficiencyParam);

                startScreen.classList.add('hidden');
                challengeIntroScreen.classList.remove('hidden');
                quizAppContainer.classList.add('show');

                challengerNameDisplay.textContent = challengedSharerName;
                challengerScoreDisplay.textContent = challengedSharerScore;
                
                // Apply color to challenged score
                challengerScoreDisplay.classList.add(getScoreColor((challengedSharerScore / parseInt(totalParam)) * 100));

                // Display challenged speed
                challengerSpeedDisplay.textContent = `Average Speed: ${challengedSharerAvgSpeed} seconds/question`;
                
                // If wrong answers log is present in URL, we could potentially display it for the challenger,
                // but for simplicity, we'll just parse it if needed for future features.
                // let parsedChallengerWrongAnswers = [];
                // try {
                //     if (wrongAnswersLogParam) {
                //         parsedChallengerWrongAnswers = JSON.parse(decodeURIComponent(wrongAnswersLogParam));
                //     }
                // } catch (e) {
                //     console.error("Error parsing challenger's wrong answers log:", e);
                // }

            } else {
                startScreen.classList.remove('hidden');
                quizAppContainer.classList.add('show');
            }
        }

        // --- Wrong Answers Review Modal Functions ---
        function showWrongAnswersModal() {
            wrongAnswersList.innerHTML = ''; // Clear previous content

            if (wrongAnswersLog.length === 0) {
                wrongAnswersList.innerHTML = '<p class="text-gray-600">Great job! You got all questions correct or answered them all within the time limit!</p>';
            } else {
                wrongAnswersLog.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.classList.add('mb-4', 'p-4', 'border', 'rounded-lg', 'bg-gray-50', 'text-left');
                    div.innerHTML = `
                        <p class="font-semibold text-gray-800 mb-2">Question ${index + 1}: ${item.question}</p>
                        <p class="text-red-600 mb-1"><i class="fas fa-times-circle mr-2"></i>Your Answer: ${item.userAnswer}</p>
                        <p class="text-green-600"><i class="fas fa-check-circle mr-2"></i>Correct Answer: ${item.correctAnswer}</p>
                    `;
                    wrongAnswersList.appendChild(div);
                });
            }
            wrongAnswersModal.classList.remove('hidden');
        }


        // --- Event Listeners ---
        window.addEventListener('load', () => {
             checkChallengeInUrl(); // Check for challenge in URL on load
             setupShareListeners();
        });
        startButton.addEventListener('click', () => startGame(false));
        startChallengeButton.addEventListener('click', () => startGame(true));
        restartButton.addEventListener('click', resetQuiz);
        reviewAnswersButton.addEventListener('click', showWrongAnswersModal); // Event listener for review button

    </script>
</body>
</html>

